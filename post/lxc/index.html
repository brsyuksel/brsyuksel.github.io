<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      lxc &middot; barış yüksel
    
  </title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>barış yüksel</p>
    <p><em>python, go, c, linux</em></p>
    <p><a href="https://twitter.com/brsyuksel">twitter</a> &middot; <a href="https://github.com/brsyuksel">github</a> &middot; <a href="https://www.linkedin.com/pub/bar%C4%B1%C5%9F-y%C3%BCksel/54/178/273">linkedin</a></p>

  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">home</a>
    <a class="sidebar-nav-item " href="/post">posts</a>

    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

  </nav>

  <div class="sidebar-item">
    <p>&copy; barış yüksel 2014.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">barış yüksel</a>
            <small>in code we trust</small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">lxc</h1>
  <span class="post-date">1 jan, 2014</span>
  

<p>lxc, açılımıyla <em>linux containers</em>, linux sistemlerde kullanabileceğiniz bir başka virtualization uygulaması/method&rsquo;udur. en öne çıkan yanı tam sanallaştırma yerine, bir init process&rsquo;inin etrafında kurulu belirli process&rsquo;lerin farklı bir kök dizini altında çalıştırılarak sanallaştırmanın gerçekleştirilmesidir. bunun yanında lxc, kernel&rsquo;in cgroups, namespace, bridging, virtual lan gibi özelliklerden yararlandığı için chroot ile full-vm arasında bir noktada denilebilir. full-vm&rsquo;ler gibi resource management uygulanabilir, device&rsquo;lar paylaşılabilir. full-vm&rsquo;lere oranla kurmak, yönetmek, yürütmek oldukça daha hızlı ve basittir.</p>

<h1 id="toc_0">kernel ve kurulum</h1>

<p>lxc&rsquo;nin yeteneklerini tam anlamıyla kullanabilmeniz için kernel&rsquo;in belirli bir şekilde derlenmiş olması gerekiyor. kernel derleme aşamasına gelmeden önce paket yöneticinizden lxc&rsquo;yi kurun.</p>

<p><strong>slackware 14.1</strong> tarafında, güncel repolarda bulunan lxc&rsquo;nin sürümü 0.9.0, bu sürüm belirli özellikleri barındırmıyor olduğu gibi slackware template&rsquo;i de içermiyor, bu nedenle slackbuilds ekibinin düzenlediği sürümü kurun. bu sürüm ise 1.0.3 olup slackware template&rsquo;i içeriyor. yalnız slackware template&rsquo;nin düzgün çalışabilmesi için patch&rsquo;lenmiş bir slackpkg&rsquo;e ihtiyaç duyacaksınız ( slackpkg&rsquo;in kodlarını inceleyince fark edersiniz ), bu da yine aynı ekip tarafından patch&rsquo;lenmiş. <a href="http://ponce.cc/slackware/testing/lxc/">lxc-1.0.3 slackbuild</a>, <a href="http://ponce.cc/slackware/utilities/">patched slackpkg</a></p>

<p>kurulumu gerçekleştirdikten sonra şu komut ile kernel durumunuzu kontrol edebilirsiniz: <code>lxc-checkconfig</code></p>

<p>çıktıda &ldquo;missing&rdquo; şeklinde bir sonuç alırsanız, bu desteği sağlayacak şekilde yeniden kernel derlemeniz gerekiyor. kernel&rsquo;i lxc için uygun olacak şekilde nasıl derleyeceğiniz hakkında bilgi man sayfasında mevcut: <code>man lxc</code></p>

<p>kernel derleme işleminde configuration&rsquo;ı tamamladıktan sonra <code>CONFIG=.config lxc-checkconfig</code> komutuyla yeni configuration&rsquo;ın eksik olup olmadığını kontrol ederek derleme işleminize geçebilirsiniz.</p>

<h1 id="toc_1">container <em>(vm)</em> oluşturma</h1>

<p>lxc ile container oluşturulurken, <em>(slackware için <code>/usr/share/lxc/templates/</code> klasörü altında yer alan)</em> template scriptleri kullanılıyor. bu template scriptleri, dağıtıma göre <strong>lxc-DISTRONAME</strong> adını taşıyan bash scriptler ve container oluşturulma anında genel olarak, dağıtımınızla benzer kök dizin hiyerarşisini oluşturuyor, container&rsquo;ın çalışması için gerekli paketleri indirip kuruyor, lxc configuration&rsquo;ını sağlanıyor. <strong>burda dikkat etmeniz gereken, host olarak kullandığınız dağıtımla container olarak kullanacağınız dağıtımın aynı olması.</strong> <em>incelediğim kadarıyla, template&rsquo;lerin içerisinde host dağıtımdan bağımsız şekilde çalışabilecek bir template yok. aslında yapılabilir bir olay ancak lxc&rsquo;i vakitten tasarruf etmek için kullandığımızı unutmamak lazım :)</em></p>

<p>hızlıca şu komutla bir container oluşturabilirsiniz:</p>

<pre><code class="language-bash">sudo lxc-create -t slackware -n deneme
</code></pre>

<p>bu komut sonrası bahsettiğim işlemler yürütülecek ve daha sonra container için gerekli paketler dağıtımın paket yöneticisi tarafından, container&rsquo;ın kök dizini altına yüklecek ve <strong>deneme</strong> adında ilk container&rsquo;ımız hazırlanmış olacak. container oluşturma işlemi fazla zamanınızı almayacaktır.</p>

<h1 id="toc_2">yürütme, durdurma, console</h1>

<p>oluşturduğumuz container&rsquo;ı yürütmek için:</p>

<pre><code class="language-bash">sudo lxc-start -n deneme -d
</code></pre>

<p><code>ps aux</code> çıktısına baktığınızda yeni bir <strong>init/systemd</strong> process&rsquo;i görüyor olmalısınız. bahsettiğim gibi yeni bir init process&rsquo;i farklı bir kök dizin altında çalışmaya başladı. şimdi bu container&rsquo;ın <strong>console</strong>&lsquo;una bağlanalım:</p>

<pre><code class="language-bash">sudo lxc-console -n deneme
</code></pre>

<p>login uygulaması ile karşılaşacaksınız. genel olarak <strong>kullanıcı: root, şifre: root</strong>. bu noktadan sonra container&rsquo;ınızı dilediğiniz gibi kullanabilirsiniz. <strong>bu console&rsquo;dan çıkmak için ctrl+a kombinasyonundan sonra q tuşuna basın.</strong></p>

<p>container&rsquo;ı <strong>durdurmak için</strong> container console&rsquo;da <code>poweroff</code> komutunu verebilirsiniz, ya da host terminal&rsquo;inden:</p>

<pre><code class="language-bash">sudo lxc-stop -n deneme
</code></pre>

<p>komutu ile container&rsquo;ı durdurabilirsiniz. bazı durumlarda bu şekilde durdurmak başarısız olabiliyor, bu nedenle <strong>-k</strong> parametresi ekleyerek container process&rsquo;lerinin <strong>kill</strong> edilerek durdurulmasını sağlayabilirsiniz.</p>

<h1 id="toc_3">freeze, unfreeze</h1>

<p>container&rsquo;ları kullanmadığınız, işlem yapmadığınız durumlarda <strong>freeze</strong> ederek <em>( SIGSTOP gibi )</em>, host tarafında işlem yükünü azaltabilirsiniz.</p>

<pre><code class="language-bash">sudo lxc-freeze -n deneme
</code></pre>

<p>freeze edilmiş bir container&rsquo;ı tekrar yürütmek için <em>( SIGCONT )</em>,</p>

<pre><code class="language-bash">sudo lxc-unfreeze -n deneme
</code></pre>

<h1 id="toc_4">dosya paylaşımı</h1>

<p>lxc&rsquo;de dosya paylaşımı diğer vm method&rsquo;larına göre çok daha kolay. eğer container&rsquo;ınız için logical volume kullanmıyorsanız, lxc rootfs&rsquo;ine host üzerinden erişiminiz mümkün. <strong>genel lxc configuration&rsquo;ı için</strong>, bu yol şu şekilde: <code>/var/lib/lxc/deneme/rootfs/</code> . bu dizin altına girdiğinizde kök dizin yapısıyla karşılaşacaksınız. dosya paylaşımlarını bu şekilde gerçekleştirebilirsiniz. bu klasöre kolayca erişmek istediğiniz zaman şu komut işinizi görecektir:</p>

<pre><code class="language-bash">su -
cd /proc/$(lxc-info -n deneme -p -H)/root
</code></pre>

<p>daha güzel bir yöntem ise container configuration&rsquo;ından yararlanmak. lxc ile host tarafındaki bir klasörün container tarafından <strong>bind-mount</strong> edilmesini sağlayabiliyoruz. bunu ister <strong>lxc container config</strong> dosyasından, isterseniz de <strong>container&rsquo;ın fstab dosyası</strong> aracılığıyla gerçekleştirebilirsiniz.</p>

<p><strong>container fstab</strong> dosyası <code>/var/lib/lxc/deneme/rootfs/etc/fstab</code> için örnek olarak şu girdiyi ekleyin:</p>

<p>/host/uzerindeki/klasor container/uzerinde/yol none bind,create=dir 0 0</p>

<p>ya da <strong>lxc container config</strong> dosyası <code>/var/lib/lxc/deneme/config</code> için şöyle bir ekleme yapabilirsiniz:</p>

<p>lxc.mount.entry = /host/uzerindeki/klasor container/uzerinde/yol none bind.create=dir 0.0</p>

<p>bu iki işlemden birini gerçekleştirdikten sonra container&rsquo;ınızı <strong>reboot</strong> edin, belirlediğiniz klasör container üzerinde mount edilmiş olacaktır.</p>

<h1 id="toc_5">network</h1>

<p>öncelikle sisteminizde <strong>bridge-utils, dnsmasq, iptables</strong> paketleri kurulu olmalı. paket yöneticiniz aracılığıyla bu paketleri kurun.</p>

<p>ilk aşamada <strong>container config dosyasında</strong> bir kaç ekleme yapmamız gerekiyor.</p>

<p><code>/var/lib/lxc/deneme/config</code></p>

<p>lxc.network.type = veth
  lxc.network.hwaddr = 00:16:3e:3a:f1:c1
  lxc.network.flags = up
  lxc.network.link = br0
  lxc.network.name = eth0</p>

<p>bu configuration ile <strong>type</strong> satırında lxc&rsquo;ye veth tunnel device kullanacağımızı bildiriyoruz. <strong>hwaddr</strong> satırı container&rsquo; için oluşturulacak device&rsquo;ın mac adresi. <strong>flags</strong> satırında device&rsquo;ı up ediyoruz. <strong>link</strong> satırında ise host tarafında var olan device&rsquo;a tunnel yapıyoruz ve <strong>name</strong> satırında container&rsquo;ın virtual device&rsquo;ının ismini belirliyoruz.</p>

<p>sıradaki işlem bir <strong>bridge device oluşturma.</strong> bunun için şu komutları uygulayabilirsiniz.</p>

<pre><code class="language-bash">su -
brctl addbr br0
brctl setfd br0 0
ifconfig br0 192.168.100.1 netmask 255.255.255.0 promisc up
</code></pre>

<p>bu aşamada <strong>br0</strong> bridge-device oluşturulmuş ve <strong>192.168.100.1 ip adresi ile</strong> up edilmiş olacaktır. kernel variable&rsquo;larında <strong>ip_forward</strong> ve <strong>br0 için proxy_arp</strong>&lsquo;ı açmamız gerekiyor, şu şekilde devam edin:</p>

<pre><code class="language-bash">echo 1 &gt; /proc/sys/net/ipv4/ip_forward
echo 1 &gt; /proc/sys/net/ipv4/conf/br0/proxy_arp
</code></pre>

<p>ve daha sonra, host sistemde <strong>nat tablosuna bir trafik yönlendirmesi kayıdı</strong> eklememiz gerekiyor <em>(ben bu örnekte internet erişimim wlan0 device&rsquo;ından gerçekleştiği için out device olarak wlan0 kullandım, siz durumuna göre gerekli değişikliği yapmalısınız)</em>:</p>

<pre><code class="language-bash">iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE
</code></pre>

<p>internet erişimi olan bir container&rsquo;a sahip olmamız için son aşama, bu container&rsquo;lara <strong>ip adresi atayacak bir dhcp server</strong>&lsquo;a ihtiyacımız var, bunun için <strong>dnsmasq</strong>&lsquo;ı kullanıyoruz.</p>

<p><strong>dnsmasq&rsquo;ın global configuration dosyasını</strong> <code>/etc/dnsmasq.conf</code> açın ve şu satırı ekleyin:</p>

<p>conf-dir=/etc/dnsmasq.d</p>

<p>şimdi <code>/etc/dnsmasq.d</code> klasörü altına gidin ( yoksa oluşturun ) ve <strong>br0.conf</strong> adında bir dosya oluşturarak <em>(dosya ismi önemli değil)</em> şu eklemeleri yapın:</p>

<p>interface=br0
  dhcp-range=192.168.100.2,192.168.100.254,72h</p>

<p>kaydettikten sonra <strong>dnsmasq&rsquo;ı başlatın</strong>. dnsmasq, container device&rsquo;larımıza 192.168.100.2-192.168.100.254 arasında bir ip atayacak.</p>

<p>şimdi: <code>sudo lxc-start -n deneme -d</code> :)</p>

<p>lxc için veth dışında farklı network yöntemleri mevcut, bunun için man sayfasından yararlanabilirsiniz.</p>

<h1 id="toc_6">daha fazlası</h1>

<p>lxc maintainer&rsquo;larından stephane graber&rsquo;in blogunda <a href="https://www.stgraber.org/2013/12/20/lxc-1-0-blog-post-series/">güzel bir yazı dizisi</a> var, okumanızı öneririm. autostart, network, storage, arch, hooks, security, namespaces, unprivilaged containers ve scripting yazılarına kesinlikle bakın derim.</p>

<h1 id="toc_7">öneri</h1>

<p>ilk olarak, daha önce virtualization işlemleri için libvirt ile tanışmış arkadaşlar için söylüyorum, libvirt güncel olarak lxc&rsquo;i desteklemektedir. libvirt&rsquo;in ilgili paketlerini kurarak libvirt ve virsh aracılığıyla container&rsquo;larınızı yönetebilirsiniz.</p>

<p>lxc&rsquo;i daha basit ve hızlı bir şekilde kullanabilmek, container&rsquo;ları yönetmek (ve daha fazlasını) istiyorsanız son derece popüler olan <a href="http://docker.io">docker.io&rsquo;ya</a> kesinlikle bakmalısınız. sitesinde hızlıca erişebileceğiniz bir &ldquo;try it&rdquo; online uygulaması mevcut, docker&rsquo;ın yeteneklerini keşfetmeniz için yeterli olacaktır. bir çok dağıtım ve küçük linux vm&rsquo;leri üzerinde çalışmak koşuluyla mac os ve windows platformları için kurulum guide&rsquo;ları mevcut.</p>

<p>full-vm aracılığıyla docker ve dolayısıyla lxc&rsquo;i kullanabileceğiniz başka bir platform <a href="https://coreos.com/">coreos linux</a>. kendisi küçük bir dağıtım olup distributed sistemlerde kolaylıkla yapılandırabileceğiniz araçlarla geliyor. incelemekte fayda var.</p>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-49309607-1', 'auto');
    ga('send', 'pageview');

  </script>
  </body>
</html>

